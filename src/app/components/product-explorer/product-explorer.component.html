<div class="explorer-container">
  <!-- Category Header -->
  <div class="category-header d-flex align-items-center" *ngIf="currentCategory && !selectedProduct">
    <button class="backBtn me-3" (click)="goBack()">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h1 class="cursiveFont mb-0 fg2">{{currentCategory.name}}</h1>
    <button class="filter-btn ms-auto btn" (click)="toggleFilterPanel()">Filters</button>
  </div>

  <!-- Button to Open Filter -->

  <!-- Filter Panel -->
  <!-- Filter Panel -->
  <div class="filter-panel" [class.active]="isFilterPanelVisible">
    <div class="filter-header">
      <h3>Filters</h3>
      <button type="button" class="btn-close" aria-label="Close" (click)="toggleFilterPanel()"></button>
    </div>

    <!-- Selected Filters Section -->
    <div class="selected-filters" *ngIf="selectedFilters.length > 0">
      <h4>Selected Filters</h4>
      <div class="selected-filter" *ngFor="let filter of selectedFilters; let i = index">
        <span>{{ filter.label }}</span>
        <button class="remove-filter-btn" (click)="removeFilter(filter)">✖</button>
      </div>
    </div>

    <!-- Sort Section -->
    <div class="filter-section">
      <h4>Sort</h4>
      <select id="sortSelect" [(ngModel)]="selectedSort" (change)="sortProducts(selectedSort)">
        <option value="lowToHigh">Price: Low to High</option>
        <option value="highToLow">Price: High to Low</option>
      </select>
    </div>

    <!-- Other Filter Sections -->
    <!-- Color Section -->
    <div class="filter-section">
      <h4>Color Options</h4>
      <div class="color-options">
        <div *ngFor="let color of availableColors" class="color-option" (click)="filterByColor(color.name)">
          <div class="color-shade" [style.backgroundColor]="color.colorCode"></div>
          <span>{{color.name}}</span>
        </div>
      </div>
    </div>

    <!-- Price Range Section -->
    <div class="filter-section">
      <h4>Price Range</h4>
      <div *ngFor="let range of priceRanges" class="price-option" (click)="filterByPrice(range)">
        <span>{{range.label}}</span>
      </div>
    </div>

    <!-- Ratings Section -->
    <div class="filter-section">
      <h4>Ratings</h4>
      <div *ngFor="let rating of ratingsOptions" class="rating-option" (click)="filterByRating(rating)">
        <span>{{rating}} ★ & Up</span>
      </div>
    </div>

    <!-- Discounts Section -->
    <div class="filter-section">
      <h4>Discounts</h4>
      <div *ngFor="let discount of discountOptions" class="discount-option" (click)="filterByDiscount(discount)">
        <span>{{discount}}% or more</span>
      </div>
    </div>

    <!-- Search Button -->
    <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">Clear all filters</button>
    <button class="search-btn" (click)="applyFilters()">Search</button>
  </div>

  <div class="search-result-message" *ngIf="searchResultMessage">
    <p class="professional-message">{{ searchResultMessage }}</p>
  </div>
  <!-- Main Content -->
  <div class="main-content" [class.hidden]="isFilterPanelVisible">
    <!-- Product Grid Section -->
    <div class="products-grid" *ngIf="!selectedProduct">
      <div class="product-card" *ngFor="let product of filteredProducts; let i = index"
        (click)="selectProduct(product)">
        <div class="image-container"
          [ngClass]="{ 'visible': product.variants[0].imagesLoaded, 'hidden': !product.variants[0].imagesLoaded }">
          <img [src]="product.variants[0].images[0]" [alt]="product.name" loading="lazy" (load)="onImageLoaded(i)">
        </div>
        <div class="placeholder" *ngIf="!product.variants[0].imagesLoaded">
          <p class="customC">Loading...</p>
        </div>
        <div class="product-info cursiveFont">
          <h3 class="fw-600">{{product.name}}</h3>
          <p class="price">From ₹{{product.basePrice}}</p>
          <div class="color-options">
            <span *ngFor="let variant of product.variants" class="color-dot" [style.background]="variant.colorCode"
              [title]="variant.color"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mDiv" *ngIf="selectedProduct && selectedVariant">
    <div class="card">
      <nav (click)="resetSelections()">
        <i class="bi bi-arrow-left"></i>
        Back to Collection
      </nav>

      <div class="photo">
        <div class="image-loading" *ngIf="!imageLoaded">
          <div class="loading-spinner"></div>
          <div class="loading-message">{{currentLoadingMessage}}</div>
        </div>
        <img [src]="currentMainImage || selectedVariant.images[0]" [alt]="selectedProduct.name" (load)="onImageLoad()"
          [class.loaded]="imageLoaded" loading="lazy">

        <div class="image-thumbnails" *ngIf="selectedVariant.images.length > 1">
          <div *ngFor="let img of selectedVariant.images; let i = index" class="thumbnail"
            [class.active]="currentMainImage === img" [class.loaded]="imageLoaded" (click)="setMainImage(img)">
            <img class="mt-10" [src]="img" [alt]="'Thumbnail ' + (i+1)" loading="lazy">
          </div>
        </div>

        <div class="image-dots" *ngIf="selectedVariant.images.length > 1">
          <span *ngFor="let img of selectedVariant.images; let i = index" [class.active]="currentMainImage === img"
            (click)="setMainImage(img)"></span>
        </div>
      </div>

      <div class="description">
        <h2>{{selectedProduct.name}}</h2>
        <h4>{{currentCategory?.name}}</h4>
        <div class="color-options">
          <span *ngFor="let variant of selectedProduct.variants" class="color-option"
            [style.backgroundColor]="variant.colorCode" (click)="selectVariant(variant)"></span>
        </div>

        <!-- Updated Price Display Section -->
        <div class="price-display" #priceDisplay>
          <div *ngIf="showOriginalPrice" class="price-step" @priceStep>
            <span class="original-price">
              ₹{{getOriginalPrice()}}
              <span class="strike-through"></span>
            </span>
          </div>

          <div *ngIf="showDiscountPercent" class="price-step" @priceStep>
            <span class="discount-percent">
              {{discountPercent}}% OFF
            </span>
          </div>

          <div *ngIf="showFinalPrice" class="price-step" @priceStep>
            <span class="final-price">
              ₹
              <span *ngFor="let digit of getFinalPriceDigits(); let i = index" class="digit"
                [style.animation-delay]="i * 100 + 'ms'">
                {{digit}}
              </span>
            </span>
          </div>
        </div>

        <p>{{selectedProduct.description}}</p>
        <button class="btn btn-primary customBtn" (click)="openModal()">Select Lenses</button>

        <!-- <button class="customBtn" [disabled]="!selectedVariant.inStock" (click)="openModal()">
          {{selectedVariant.inStock ? 'Buy Now' : 'Out of Stock'}}
        </button> -->
      </div>
    </div>
  </div>
</div>



<!-- Bootstrap Modal -->
<div class="modal fade" id="lensModal" tabindex="-1" aria-labelledby="lensModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header d-flex align-items-center">
        <!-- Back Button (for Step 2 and Step 3) -->
        <button *ngIf="currentStep > 1" class="btn btn-link p-0 me-3" (click)="goBackForToggle()">
          <i class="bi bi-arrow-left-circle" style="font-size: 1.5rem; color: #2c3e50;"></i>
        </button>

        <!-- Dynamic Heading -->
        <h5 class="modal-title flex-grow-1 text-center">
          {{ currentStep === 1 ? 'Select Lens Type' : currentStep === 2 ? 'Choose Lens Package' : 'View Complete
          Details' }}
        </h5>

        <!-- Close Icon -->
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Step Navigation -->
        <div class="steps">
          <div *ngFor="let step of steps; let index = index" class="step" [class.active]="currentStep === index + 1">
            {{ index + 1 }}
          </div>
        </div>

        <!-- Step 1: Select Lenses -->
        <div *ngIf="currentStep === 1">
          <ul class="list-group">
            <!-- Single Vision -->
            <li class="list-group-item lens-option d-flex align-items-center justify-content-between"
              (click)="selectMainOption('single-vision')">
              <i class="bi bi-eye-fill left-icon"></i> <!-- Left Icon -->
              <div class="text-center flex-grow-1">
                <h5 class="mb-1">Single Vision</h5>
                <p class="text-muted">For distance or near vision (Thin, anti-glare, blue-cut options)</p>
              </div>
              <i class="bi bi-arrow-right-circle-fill right-icon"></i> <!-- Right Icon -->
            </li>

            <!-- Bifocal/Progressive -->
            <li class="list-group-item lens-option d-flex align-items-center justify-content-between"
              (click)="selectMainOption('bifocal')">
              <i class="bi bi-glasses left-icon"></i> <!-- Left Icon -->
              <div class="text-center flex-grow-1">
                <h5 class="mb-1">Bifocal/Progressive</h5>
                <p class="text-muted">Bifocal and Progressives (For two powers in same lenses)</p>
              </div>
              <i class="bi bi-arrow-right-circle-fill right-icon"></i> <!-- Right Icon -->
            </li>

            <!-- Zero Power -->
            <li class="list-group-item lens-option d-flex align-items-center justify-content-between"
              (click)="selectMainOption('zero-power')">
              <i class="bi bi-shield-check left-icon"></i> <!-- Left Icon -->
              <div class="text-center flex-grow-1">
                <h5 class="mb-1">Zero Power</h5>
                <p class="text-muted">Block 98% of harmful rays (Anti-glare and blue-cut options)</p>
              </div>
              <i class="bi bi-arrow-right-circle-fill right-icon"></i> <!-- Right Icon -->
            </li>

            <!-- Frame Only -->
            <li class="list-group-item lens-option d-flex align-items-center justify-content-between"
              (click)="selectFrameOnly()">
              <i class="bi bi-box left-icon"></i> <!-- Left Icon -->
              <div class="text-center flex-grow-1">
                <h5 class="mb-1">Frame Only</h5>
                <p class="text-muted">Buy Only Frame</p>
              </div>
              <i class="bi bi-arrow-right-circle-fill right-icon"></i> <!-- Right Icon -->
            </li>
          </ul>
        </div>

        <!-- Step 2: Sub-options -->
        <div *ngIf="currentStep === 2">
          <div class="row">
            <div class="col-md-6 mb-4" *ngFor="let option of subOptions" (click)="selectSubOption(option)">
              <div class="card shadow-sm gradient-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title">{{ option }}</h5>
                    <i class="bi bi-arrow-right-circle-fill"></i>
                  </div>
                  <ul class="list-unstyled">
                    <li *ngFor="let detail of optionDetails[option]">
                      {{ detail }}
                    </li>
                  </ul>
                  <div class="price-container mt-3 text-center">
                    Frame+Lens: Get it for ₹{{ prices[option] }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="currentStep === 3">
          <h5 class="text-primary text-center mb-4 fade-in-animation">Order Details:</h5>

          <!-- Product Details Card -->
          <div class="card shadow-sm border-0 modern-card">
            <div class="row g-0">
              <!-- Product Image -->
              <div class="col-md-4">
                <img [src]="selectedVariant.images[0]" class="img-fluid rounded-start product-image"
                  alt="{{ selectedProduct?.name || 'Product Image' }}" />
              </div>

              <!-- Product Details -->
              <div class="col-md-8">
                <div class="card-body">
                  <!-- Product Name -->
                  <h5 class="card-title mb-3 fade-in-animation">{{ selectedProduct?.name }}</h5>

                  <!-- Variant -->
                  <p class="card-text text-muted fade-in-animation">
                    <strong>Variant:</strong> {{ selectedVariant?.color || 'Default Variant' }}
                  </p>

                  <!-- Quantity -->
                  <p class="card-text text-muted fade-in-animation">
                    <strong>Quantity:</strong> {{ selectedQuantity || 1 }}
                  </p>

                  <!-- Price -->
                  <p class="card-text text-muted fade-in-animation">
                    <strong>Price:</strong> ₹{{ selectedProduct?.basePrice }}
                  </p>

                  <!-- Frame + Popup Selection Price -->
                  <div class="price-container mt-3 p-2 text-center rounded fade-in-animation">
                    Frame + Lens Price: ₹{{ prices[selection.subOption] + selectedProduct?.basePrice }}
                  </div>

                  <!-- Proceed Button -->
                  <button class="btn btn-primary mt-4 w-100 proceed-button fade-in-animation"
                    (click)="proceedToBuy()">Proceed to Buy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>